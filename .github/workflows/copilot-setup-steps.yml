name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

env:
  GITHUB_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_PERSONAL_ACCESS_TOKEN }}
  GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_PERSONAL_ACCESS_TOKEN }}
  DISPLAY: ":99"

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      contents: read
      actions: read
      attestations: read
      checks: read
      deployments: read
      issues: write
      models: read
      discussions: read
      pages: read
      pull-requests: write
      security-events: read
      statuses: read

    # Steps run before the agent starts working
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # Start Xvfb early for Playwright/Chrome
      - name: Start Xvfb
        run: |
          echo "ðŸ–¥ï¸ Starting Xvfb virtual display..."
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          echo "DISPLAY=:99" >> $GITHUB_ENV
          echo "âœ… Xvfb started on display :99"

      # Cache APT packages for faster installs
      - name: Cache APT packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/copilot-setup-steps.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      # Setup complete Three.js test environment
      - name: Setup Three.js Test Environment (Chrome + Xvfb + Dependencies)
        run: |
          echo "ðŸ”§ Setting up complete Three.js test environment..."

          # Install system dependencies for Three.js rendering
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb dbus-x11 x11-utils \
            libgtk2.0-0 libgtk-3-0 libgbm-dev libgbm1 \
            libnotify-dev libnss3 libxss1 \
            libxtst6 xauth \
            graphviz ffmpeg \
            fonts-noto fonts-noto-cjk fonts-noto-cjk-extra \
            ca-certificates fonts-liberation \
            libatk-bridge2.0-0 libatk1.0-0 libcups2 \
            libdbus-1-3 libdrm2 libnspr4 \
            libx11-xcb1 libxcomposite1 libxdamage1 \
            libxfixes3 libxrandr2 libxrender1 \
            libxshmfence1 xdg-utils wget libxkbcommon0 xkb-data

          # Install Google Chrome Stable for Three.js WebGL support
          wget -qO- https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

          # Setup D-Bus for Chrome
          sudo mkdir -p /var/run/dbus
          sudo dbus-daemon --system --fork || true
                    
          # Verify Chrome installation
          google-chrome --version
          echo "âœ… Three.js test environment setup complete"
        env:
          DISPLAY: ":99"
          XKB_DEFAULT_RULES: evdev
          XKB_DEFAULT_MODEL: pc105
          XKB_DEFAULT_LAYOUT: us

      # JavaScript/TypeScript setup
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
          cache: "npm"

      - name: Cache dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      # Cache global npm packages for MCP servers
      - name: Cache global npm packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.npm
            /usr/local/lib/node_modules
            /usr/local/bin/mcp-server-*
          key: ${{ runner.os }}-mcp-servers-v4-${{ hashFiles('.github/copilot-mcp.json') }}
          restore-keys: |
            ${{ runner.os }}-mcp-servers-v4-

      # Pre-install MCP server packages globally
      - name: Install MCP server packages globally
        run: |
          echo "ðŸ“¦ Installing MCP server packages globally..."
          
          # Install Node.js MCP servers that exist on npm
          npm install -g @modelcontextprotocol/server-filesystem
          npm install -g @modelcontextprotocol/server-memory
          npm install -g @modelcontextprotocol/server-sequential-thinking
          
          # Pre-cache @playwright/mcp for faster startup
          npm install -g @playwright/mcp
          
          echo "âœ… Node.js MCP server packages installed globally"


      # Verify all MCP server installations
      - name: Verify MCP server installations
        run: |
          echo "ðŸ” Verifying MCP server installations..."
          
          echo "=== Node.js MCP Servers ==="
          echo "Checking mcp-server-filesystem..."
          which mcp-server-filesystem && echo "âœ… mcp-server-filesystem found" || echo "âŒ mcp-server-filesystem NOT found"
          
          echo "Checking mcp-server-memory..."
          which mcp-server-memory && echo "âœ… mcp-server-memory found" || echo "âŒ mcp-server-memory NOT found"
          
          echo "Checking mcp-server-sequential-thinking..."
          which mcp-server-sequential-thinking && echo "âœ… mcp-server-sequential-thinking found" || echo "âŒ mcp-server-sequential-thinking NOT found"
          
          echo "Checking @playwright/mcp..."
          which mcp-server-playwright 2>/dev/null && echo "âœ… mcp-server-playwright found" || echo "â„¹ï¸ @playwright/mcp available via npx"
                    
          echo ""
          echo "=== HTTP MCP Servers ==="
          echo "ðŸ“ GitHub MCP Server: Using HTTP endpoint (https://api.githubcopilot.com/mcp/insiders)"         
          echo "âœ… MCP server verification complete"

      - name: Install Playwright browsers (and OS deps)
        run: npx playwright install --with-deps
        env:
          DISPLAY: ":99"
          PLAYWRIGHT_BROWSERS_PATH: "0"
        
      - name: Cache Cypress binary
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Verify Cypress for Three.js Testing
        run: |
          npx cypress verify
          npx cypress info
          echo "âœ… Cypress verified and ready for Three.js tests"

      - name: Display environment info
        run: |
          echo "========================================="
          echo "Environment Setup Complete"
          echo "========================================="
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "TypeScript version: $(npx tsc --version)"
          echo "Cypress version: $(npx cypress version)"
          echo "Chrome version: $(google-chrome --version)"
          echo "Display: $DISPLAY"
          echo "Xvfb running: $(pgrep -x Xvfb >/dev/null && echo 'Yes' || echo 'No')"
          echo "D-Bus running: $(pgrep -x dbus-daemon >/dev/null && echo 'Yes' || echo 'No')"
          echo "Working directory: $(pwd)"
          echo "Build artifacts: $(ls -la dist/ 2>/dev/null | wc -l) files"
          echo "========================================="
          echo "MCP Servers Available:"
          echo "- GitHub MCP Server: HTTP (https://api.githubcopilot.com/mcp/insiders)"
          echo "- mcp-server-filesystem: $(which mcp-server-filesystem 2>/dev/null || echo 'not found')"
          echo "- mcp-server-memory: $(which mcp-server-memory 2>/dev/null || echo 'not found')"
          echo "- mcp-server-sequential-thinking: $(which mcp-server-sequential-thinking 2>/dev/null || echo 'not found')"
          echo "- Playwright MCP: @playwright/mcp (via npx)"
          echo "========================================="
          echo "Three.js Test Environment Ready"
          echo "- WebGL rendering: SwiftShader (software)"
          echo "- Target FPS: 30-60fps"
          echo "- Memory limit: 4GB Node.js heap"
          echo "=========================================="
        env:
          DISPLAY: ":99"

      - name: Cache build artifacts
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: .tsbuildinfo
          key: ${{ runner.os }}-tsbuild-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-tsbuild-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-tsbuild-
