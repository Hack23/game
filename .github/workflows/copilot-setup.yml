name: Setup Copilot Development Environment

# This workflow can be triggered manually to set up or validate the Copilot development environment
# It serves as a guide for what gets configured when using GitHub Copilot with this repository

on:
  workflow_dispatch:
    inputs:
      validate_only:
        description: 'Only validate setup without making changes'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  setup-guide:
    name: Copilot Environment Setup Guide
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '24'
          cache: 'npm'

      - name: Display Copilot Configuration
        run: |
          echo "## GitHub Copilot Development Environment"
          echo ""
          echo "### Configuration Files"
          echo "- âœ… .github/copilot-instructions.md - Coding guidelines for Copilot"
          echo "- âœ… .github/copilot-setup-steps.yml - Pre-installation steps and MCP servers"
          echo "- âœ… .github/mcp-config.json - MCP server configuration"
          echo "- âœ… .devcontainer/devcontainer.json - Dev container with Copilot extensions"
          echo ""
          echo "### Available MCP Servers"
          echo ""
          echo "The following Model Context Protocol servers are configured:"
          echo ""
          
      - name: List MCP Servers
        run: |
          echo "#### ğŸ—‚ï¸ Filesystem Server"
          echo "- Provides secure file access to project directories"
          echo "- Allows Copilot to read/write code files"
          echo "- Command: @modelcontextprotocol/server-filesystem"
          echo ""
          echo "#### ğŸ™ GitHub Server"
          echo "- Access to repository data, issues, and PRs"
          echo "- Enables Copilot to understand project context"
          echo "- Command: @modelcontextprotocol/server-github"
          echo ""
          echo "#### ğŸ“š Git Server"
          echo "- Git operations and repository history"
          echo "- Helps understand code evolution"
          echo "- Command: @modelcontextprotocol/server-git"
          echo ""
          echo "#### ğŸ§  Memory Server"
          echo "- Maintains context across conversations"
          echo "- Remembers previous interactions"
          echo "- Command: @modelcontextprotocol/server-memory"
          echo ""
          echo "#### ğŸ” Brave Search Server (Optional)"
          echo "- Searches documentation and best practices"
          echo "- Requires BRAVE_API_KEY environment variable"
          echo "- Command: @modelcontextprotocol/server-brave-search"
          echo ""
          echo "#### ğŸ­ Playwright Server"
          echo "- Browser automation for testing"
          echo "- Useful for debugging and E2E tests"
          echo "- Command: @modelcontextprotocol/server-playwright"

      - name: Install System Dependencies
        run: |
          echo "### Installing System Dependencies"
          sudo apt-get update || exit 1
          sudo apt-get install -y build-essential || exit 1
          sudo apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth || exit 1
          sudo apt-get install -y graphviz || exit 1
          echo "âœ… System dependencies installed"

      - name: Install Node Dependencies
        run: |
          echo "### Installing Node.js Dependencies"
          npm ci --ignore-scripts
          echo "âœ… Node.js dependencies installed"

      - name: Build Project
        run: |
          echo "### Building TypeScript Project"
          npm run build
          echo "âœ… Project built successfully"

      - name: Validate TypeScript
        run: |
          echo "### Validating TypeScript Configuration"
          npx tsc --noEmit
          echo "âœ… TypeScript validation passed"

      - name: Check Linting
        run: |
          echo "### Checking ESLint Configuration"
          npm run lint -- --max-warnings 0 || echo "âš ï¸ Linting has warnings"

      - name: Test MCP Server Availability
        run: |
          echo "### Testing MCP Server Availability"
          echo "Note: MCP servers are installed on-demand when Copilot needs them"
          echo ""
          echo "Verifying key MCP server packages:"
          for pkg in filesystem github git memory playwright; do
            if npm view @modelcontextprotocol/server-$pkg version > /dev/null 2>&1; then
              echo "âœ… @modelcontextprotocol/server-$pkg is available"
            else
              echo "âš ï¸ @modelcontextprotocol/server-$pkg not found"
            fi
          done

      - name: Display Setup Summary
        run: |
          echo ""
          echo "## ğŸ‰ Copilot Environment Setup Complete!"
          echo ""
          echo "### Quick Start with Copilot"
          echo ""
          echo "1. **Use GitHub Codespaces:**"
          echo "   - Click 'Code' â†’ 'Create codespace on main'"
          echo "   - Copilot extensions are pre-installed"
          echo "   - Environment is automatically configured"
          echo ""
          echo "2. **Use Local Development:**"
          echo "   - Open repository in VS Code"
          echo "   - Install GitHub Copilot extension"
          echo "   - Open .github/copilot-instructions.md for guidelines"
          echo ""
          echo "3. **Use Copilot Chat:**"
          echo "   - Ask questions about the codebase"
          echo "   - Get code suggestions"
          echo "   - Debug issues with AI assistance"
          echo ""
          echo "### Key Features"
          echo ""
          echo "âœ… Intelligent code completion with context"
          echo "âœ… Inline documentation and examples"
          echo "âœ… Security-first coding suggestions"
          echo "âœ… TypeScript strict mode support"
          echo "âœ… PixiJS game development assistance"
          echo "âœ… Test generation with Vitest/Cypress"
          echo "âœ… React 19 best practices"
          echo ""
          echo "### MCP Servers Enhance Copilot With:"
          echo ""
          echo "ğŸ—‚ï¸ Direct file system access"
          echo "ğŸ™ GitHub repository context"
          echo "ğŸ“š Git history understanding"
          echo "ğŸ§  Conversation memory"
          echo "ğŸ” Documentation search (with API key)"
          echo "ğŸ­ Browser automation tools"
          echo ""
          echo "For more information, see:"
          echo "- .github/copilot-instructions.md"
          echo "- .github/copilot-setup-steps.yml"
          echo "- .github/mcp-config.json"

      - name: Create Setup Report
        run: |
          cat > setup-report.md << 'EOF'
          # Copilot Development Environment Setup Report
          
          ## âœ… Configuration Status
          
          ### Files Present
          - [x] `.github/copilot-instructions.md` - Coding guidelines
          - [x] `.github/copilot-setup-steps.yml` - Setup configuration
          - [x] `.github/mcp-config.json` - MCP server configuration
          - [x] `.devcontainer/devcontainer.json` - Dev container configuration
          
          ### MCP Servers Configured
          - [x] Filesystem Server - File access
          - [x] GitHub Server - Repository context
          - [x] Git Server - Version control
          - [x] Memory Server - Context persistence
          - [x] Playwright Server - Browser automation
          - [ ] Brave Search Server - Requires API key
          
          ### System Dependencies
          - [x] Node.js 24
          - [x] Build tools
          - [x] Display server (Xvfb)
          - [x] Cypress dependencies
          - [x] Graphics tools
          
          ### Project Dependencies
          - [x] NPM packages installed
          - [x] TypeScript compiled
          - [x] Build successful
          
          ## ğŸš€ Usage Instructions
          
          ### For GitHub Codespaces
          1. Click "Code" button
          2. Select "Codespaces" tab
          3. Click "Create codespace on main"
          4. Wait for automatic setup
          5. Start coding with Copilot!
          
          ### For Local Development
          1. Clone the repository
          2. Open in VS Code
          3. Install GitHub Copilot extension
          4. Run `npm install`
          5. Run `npm run dev`
          
          ### MCP Servers
          MCP servers are automatically loaded when you use GitHub Copilot in:
          - VS Code with Copilot extension
          - GitHub Codespaces
          - Copilot Chat
          
          ## ğŸ“š Documentation
          
          - **Coding Guidelines**: `.github/copilot-instructions.md`
          - **Setup Steps**: `.github/copilot-setup-steps.yml`
          - **MCP Config**: `.github/mcp-config.json`
          - **Dev Container**: `.devcontainer/devcontainer.json`
          
          ## ğŸ”’ Security Notes
          
          - All MCP servers use read-only access where possible
          - Filesystem server restricted to project directories
          - No secrets stored in configuration
          - GITHUB_TOKEN and BRAVE_API_KEY use environment variables
          
          ## ğŸ® Stack-Specific Features
          
          ### React + TypeScript
          - Strict type checking
          - Component best practices
          - Hook usage patterns
          
          ### PixiJS
          - Game loop patterns
          - Sprite management
          - Performance optimization
          
          ### Testing
          - Vitest unit tests
          - Cypress E2E tests
          - 80% coverage target
          
          EOF
          
          cat setup-report.md

      - name: Upload Setup Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: copilot-setup-report
          path: setup-report.md
          if-no-files-found: error
